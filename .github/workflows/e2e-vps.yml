name: E2E VPS Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  SSH_KEY_NAME: frost-e2e-ci

jobs:
  e2e-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 50
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            server_type: cax21
            snapshot_id: "349804713"
          - arch: amd64
            server_type: cx23
            snapshot_id: "349804999"

    name: e2e-vps (${{ matrix.arch }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create server from snapshot
        id: server
        run: |
          echo "Creating server from snapshot..."
          DELAYS=(30 60 120 240 600 1200)
          MAX_ATTEMPTS=${#DELAYS[@]}

          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "Attempt $attempt/$MAX_ATTEMPTS..."
            RESPONSE=$(curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.HETZNER_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{
                "name": "frost-e2e-${{ github.run_id }}-${{ matrix.arch }}",
                "server_type": "${{ matrix.server_type }}",
                "image": "${{ matrix.snapshot_id }}",
                "location": "hel1",
                "ssh_keys": ["${{ env.SSH_KEY_NAME }}"],
                "start_after_create": true,
                "labels": {"purpose": "frost-e2e"}
              }' \
              "https://api.hetzner.cloud/v1/servers")

            SERVER_ID=$(echo "$RESPONSE" | jq -r '.server.id')
            SERVER_IP=$(echo "$RESPONSE" | jq -r '.server.public_net.ipv4.ip')

            if [ "$SERVER_ID" != "null" ] && [ -n "$SERVER_ID" ]; then
              echo "server_id=$SERVER_ID" >> $GITHUB_OUTPUT
              echo "ip=$SERVER_IP" >> $GITHUB_OUTPUT
              echo "Server created: ID=$SERVER_ID, IP=$SERVER_IP"
              exit 0
            fi

            ERROR_CODE=$(echo "$RESPONSE" | jq -r '.error.code // empty')
            echo "Failed to create server (error: $ERROR_CODE):"
            echo "$RESPONSE" | jq

            if [ "$attempt" -lt "$MAX_ATTEMPTS" ]; then
              DELAY=${DELAYS[$((attempt - 1))]}
              echo "Waiting ${DELAY}s before retry..."
              sleep $DELAY
            fi
          done

          echo "All $MAX_ATTEMPTS attempts failed"
          exit 1

      - name: Wait for server ready
        run: |
          echo "Waiting for server to be running..."
          for i in {1..30}; do
            STATUS=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.HETZNER_API_TOKEN }}" \
              "https://api.hetzner.cloud/v1/servers/${{ steps.server.outputs.server_id }}" \
              | jq -r '.server.status')

            echo "Server status: $STATUS"
            if [ "$STATUS" = "running" ]; then
              echo "Server is running!"
              break
            fi
            sleep 5
          done

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ steps.server.outputs.ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Wait for SSH
        run: |
          echo "Waiting for SSH..."
          for i in {1..30}; do
            if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no root@${{ steps.server.outputs.ip }} "echo 'SSH ready'" 2>/dev/null; then
              echo "SSH is ready!"
              exit 0
            fi
            echo "Attempt $i: SSH not ready..."
            sleep 5
          done
          echo "SSH failed"
          exit 1

      - name: Install Frost
        id: install
        run: |
          BRANCH="${{ github.head_ref || github.ref_name }}"
          REPO="${{ github.repository }}"
          INSTALL_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/install.sh"

          echo "Installing from: $INSTALL_URL"
          echo "Using branch: $BRANCH"

          # Stream output to both file and stdout for debugging
          ssh -o ServerAliveInterval=30 root@${{ steps.server.outputs.ip }} "curl -fsSL '$INSTALL_URL' -o /tmp/install.sh && chmod +x /tmp/install.sh && echo '${{ secrets.FROST_TEST_PASSWORD }}' | /tmp/install.sh -b '$BRANCH' --create-api-key" 2>&1 | tee /tmp/install-output.txt

          API_KEY=$(cat /tmp/install-output.txt | sed 's/\x1b\[[0-9;]*m//g' | grep "API Key:" | awk '{print $3}')

          if [ -z "$API_KEY" ]; then
            echo "Failed to extract API key"
            echo "=== Full install output ==="
            cat /tmp/install-output.txt
            exit 1
          fi

          echo "api_key=$API_KEY" >> $GITHUB_OUTPUT
          echo "API key extracted"

          # Initialize git repos for test fixtures (needed for local repo cloning)
          ssh root@${{ steps.server.outputs.ip }} 'git config --global user.email "ci@frost.dev" && git config --global user.name "Frost CI" && git config --global --add safe.directory "*"
            for dir in /opt/frost/apps/app/test/fixtures/*/; do
              if [ ! -d "$dir/.git" ]; then
                cd "$dir" && git init -b main && git add -A && git commit -m "init"
              fi
            done'

      - name: Wait for Frost
        run: |
          echo "Waiting for Frost..."
          for i in {1..12}; do
            if curl -s -o /dev/null -w "%{http_code}" "http://${{ steps.server.outputs.ip }}/api/health" | grep -q "200"; then
              echo "Frost is ready!"
              exit 0
            fi
            echo "Attempt $i: Frost not ready..."
            sleep 5
          done
          echo "Frost failed to start"
          ssh root@${{ steps.server.outputs.ip }} "journalctl -u frost --no-pager -n 50" || true
          exit 1

      - name: Run E2E tests
        env:
          E2E_BRANCH: ${{ github.head_ref || github.ref_name }}
        run: |
          chmod +x ./apps/app/scripts/e2e-test.sh
          ./apps/app/scripts/e2e-test.sh "${{ steps.server.outputs.ip }}" "${{ steps.install.outputs.api_key }}"

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Frost logs (last 500 lines) ==="
          ssh root@${{ steps.server.outputs.ip }} "journalctl -u frost --no-pager -n 500" || true
          echo ""
          echo "=== Caddy logs ==="
          ssh root@${{ steps.server.outputs.ip }} "journalctl -u caddy --no-pager -n 50" || true
          echo ""
          echo "=== Docker ==="
          ssh root@${{ steps.server.outputs.ip }} "docker ps -a" || true

      - name: Delete server
        if: always() && steps.server.outputs.server_id
        run: |
          echo "Deleting server ${{ steps.server.outputs.server_id }}..."
          curl -s -X DELETE \
            -H "Authorization: Bearer ${{ secrets.HETZNER_API_TOKEN }}" \
            "https://api.hetzner.cloud/v1/servers/${{ steps.server.outputs.server_id }}"
          echo "Server deleted"
