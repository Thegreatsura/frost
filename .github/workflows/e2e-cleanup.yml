name: E2E Cleanup

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete old E2E servers
        run: |
          SERVERS=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.HETZNER_API_TOKEN }}" \
            "https://api.hetzner.cloud/v1/servers?label_selector=purpose=frost-e2e")

          NOW=$(date +%s)
          MAX_AGE=3000

          echo "$SERVERS" | jq -r '.servers[] | "\(.id) \(.created)"' | while read ID CREATED; do
            CREATED_TS=$(date -d "$CREATED" +%s)
            AGE=$((NOW - CREATED_TS))

            if [ "$AGE" -gt "$MAX_AGE" ]; then
              echo "Deleting server $ID (age: ${AGE}s)"
              curl -s -X DELETE \
                -H "Authorization: Bearer ${{ secrets.HETZNER_API_TOKEN }}" \
                "https://api.hetzner.cloud/v1/servers/$ID"
            else
              echo "Keeping server $ID (age: ${AGE}s)"
            fi
          done

          echo "Cleanup complete"
