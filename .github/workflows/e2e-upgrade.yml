name: E2E Upgrade Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

env:
  SSH_KEY_NAME: frost-e2e-ci

jobs:
  e2e-upgrade:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            server_type: cax21
            snapshot_id: "349804713"
          - arch: amd64
            server_type: cx23
            snapshot_id: "349804999"

    name: e2e-upgrade (${{ matrix.arch }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest release tag
        id: release
        run: |
          TAG=$(gh api repos/${{ github.repository }}/releases/latest --jq '.tag_name' 2>/dev/null || echo "")
          if [ -z "$TAG" ]; then
            echo "No releases found, skipping upgrade test"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Latest release: $TAG"
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create server from snapshot
        if: steps.release.outputs.skip != 'true'
        id: server
        run: |
          echo "Creating server from snapshot..."
          DELAYS=(30 60 120 240 600 1200)
          MAX_ATTEMPTS=${#DELAYS[@]}

          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "Attempt $attempt/$MAX_ATTEMPTS..."
            RESPONSE=$(curl -s -X POST \
              -H "Authorization: Bearer ${{ secrets.HETZNER_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{
                "name": "frost-upgrade-${{ github.run_id }}-${{ matrix.arch }}",
                "server_type": "${{ matrix.server_type }}",
                "image": "${{ matrix.snapshot_id }}",
                "location": "hel1",
                "ssh_keys": ["${{ env.SSH_KEY_NAME }}"],
                "start_after_create": true,
                "labels": {"purpose": "frost-e2e-upgrade"}
              }' \
              "https://api.hetzner.cloud/v1/servers")

            SERVER_ID=$(echo "$RESPONSE" | jq -r '.server.id')
            SERVER_IP=$(echo "$RESPONSE" | jq -r '.server.public_net.ipv4.ip')

            if [ "$SERVER_ID" != "null" ] && [ -n "$SERVER_ID" ]; then
              echo "server_id=$SERVER_ID" >> $GITHUB_OUTPUT
              echo "ip=$SERVER_IP" >> $GITHUB_OUTPUT
              echo "Server created: ID=$SERVER_ID, IP=$SERVER_IP"
              exit 0
            fi

            ERROR_CODE=$(echo "$RESPONSE" | jq -r '.error.code // empty')
            echo "Failed to create server (error: $ERROR_CODE):"
            echo "$RESPONSE" | jq

            if [ "$attempt" -lt "$MAX_ATTEMPTS" ]; then
              DELAY=${DELAYS[$((attempt - 1))]}
              echo "Waiting ${DELAY}s before retry..."
              sleep $DELAY
            fi
          done

          echo "All $MAX_ATTEMPTS attempts failed"
          exit 1

      - name: Wait for server ready
        if: steps.release.outputs.skip != 'true'
        run: |
          echo "Waiting for server to be running..."
          for i in {1..30}; do
            STATUS=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.HETZNER_API_TOKEN }}" \
              "https://api.hetzner.cloud/v1/servers/${{ steps.server.outputs.server_id }}" \
              | jq -r '.server.status')

            echo "Server status: $STATUS"
            if [ "$STATUS" = "running" ]; then
              echo "Server is running!"
              break
            fi
            sleep 5
          done

      - name: Setup SSH
        if: steps.release.outputs.skip != 'true'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ steps.server.outputs.ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Wait for SSH
        if: steps.release.outputs.skip != 'true'
        run: |
          echo "Waiting for SSH..."
          for i in {1..30}; do
            if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no root@${{ steps.server.outputs.ip }} "echo 'SSH ready'" 2>/dev/null; then
              echo "SSH is ready!"
              exit 0
            fi
            echo "Attempt $i: SSH not ready..."
            sleep 5
          done
          echo "SSH failed"
          exit 1

      - name: Install Frost from latest release
        if: steps.release.outputs.skip != 'true'
        id: install
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          INSTALL_URL="https://raw.githubusercontent.com/${{ github.repository }}/${TAG}/install.sh"

          echo "Installing Frost $TAG from: $INSTALL_URL"

          ssh -o ServerAliveInterval=30 root@${{ steps.server.outputs.ip }} "curl -fsSL '$INSTALL_URL' -o /tmp/install.sh && chmod +x /tmp/install.sh && echo '${{ secrets.FROST_TEST_PASSWORD }}' | /tmp/install.sh -v '$TAG' --create-api-key" 2>&1 | tee /tmp/install-output.txt

          API_KEY=$(cat /tmp/install-output.txt | sed 's/\x1b\[[0-9;]*m//g' | grep "API Key:" | awk '{print $3}')

          if [ -z "$API_KEY" ]; then
            echo "Failed to extract API key"
            echo "=== Full install output ==="
            cat /tmp/install-output.txt
            exit 1
          fi

          echo "api_key=$API_KEY" >> $GITHUB_OUTPUT
          echo "API key extracted: ${API_KEY:0:12}..."

      - name: Wait for Frost (pre-upgrade)
        if: steps.release.outputs.skip != 'true'
        run: |
          echo "Waiting for Frost..."
          for i in {1..12}; do
            if curl -s -o /dev/null -w "%{http_code}" "http://${{ steps.server.outputs.ip }}/api/health" | grep -q "200"; then
              echo "Frost is ready!"
              exit 0
            fi
            echo "Attempt $i: Frost not ready..."
            sleep 5
          done
          echo "Frost failed to start"
          ssh root@${{ steps.server.outputs.ip }} "journalctl -u frost --no-pager -n 50" || true
          exit 1

      - name: Create pre-upgrade test data
        if: steps.release.outputs.skip != 'true'
        id: predata
        run: |
          chmod +x ./scripts/e2e-upgrade-create.sh
          ./scripts/e2e-upgrade-create.sh "${{ steps.server.outputs.ip }}" "${{ steps.install.outputs.api_key }}"

      - name: Upgrade to PR branch
        if: steps.release.outputs.skip != 'true'
        run: |
          BRANCH="${{ github.head_ref || github.ref_name }}"
          REPO="${{ github.repository }}"

          echo "Upgrading from ${{ steps.release.outputs.tag }} to branch: $BRANCH"

          ssh -o ServerAliveInterval=30 root@${{ steps.server.outputs.ip }} "cd /opt/frost && \
            systemctl stop frost && \
            git config --global --add safe.directory /opt/frost && \
            if [ ! -d .git ]; then \
              echo 'Initializing git repo (tarball installation detected)'; \
              git init && \
              git remote add origin https://github.com/${REPO}.git; \
            else \
              git remote set-url origin https://github.com/${REPO}.git; \
            fi && \
            git fetch origin ${BRANCH} && \
            git checkout -f -B ${BRANCH} origin/${BRANCH} && \
            rm -rf node_modules package-lock.json && \
            export BUN_INSTALL=\"\$HOME/.bun\" && \
            export PATH=\"\$BUN_INSTALL/bin:\$PATH\" && \
            NODE_ENV=development npm install --legacy-peer-deps --silent 2>&1 && \
            npm run build 2>&1 && \
            bun run migrate 2>&1 && \
            systemctl start frost"

      - name: Wait for Frost (post-upgrade)
        if: steps.release.outputs.skip != 'true'
        run: |
          echo "Waiting for Frost after upgrade..."
          for i in {1..12}; do
            if curl -s -o /dev/null -w "%{http_code}" "http://${{ steps.server.outputs.ip }}/api/health" | grep -q "200"; then
              echo "Frost is ready!"
              exit 0
            fi
            echo "Attempt $i: Frost not ready..."
            sleep 5
          done
          echo "Frost failed to start after upgrade"
          ssh root@${{ steps.server.outputs.ip }} "journalctl -u frost --no-pager -n 100" || true
          exit 1

      - name: Verify pre-upgrade data survived
        if: steps.release.outputs.skip != 'true'
        run: |
          chmod +x ./scripts/e2e-upgrade-verify.sh
          ./scripts/e2e-upgrade-verify.sh \
            "${{ steps.server.outputs.ip }}" \
            "${{ steps.install.outputs.api_key }}" \
            "${{ steps.predata.outputs.project_id }}" \
            "${{ steps.predata.outputs.service_id }}" \
            "${{ steps.predata.outputs.deployment_id }}"

      - name: Run standard E2E tests
        if: steps.release.outputs.skip != 'true'
        run: |
          chmod +x ./scripts/e2e-test.sh
          ./scripts/e2e-test.sh "${{ steps.server.outputs.ip }}" "${{ steps.install.outputs.api_key }}"

      - name: Reset to release version for UI update test
        if: steps.release.outputs.skip != 'true'
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          echo "Resetting to release $TAG for UI update test..."

          ssh -o ServerAliveInterval=30 root@${{ steps.server.outputs.ip }} "cd /opt/frost && \
            systemctl stop frost && \
            rm -rf repos && \
            git fetch origin && \
            git checkout $TAG && \
            git reset --hard $TAG && \
            git clean -fdx -e data -e .env && \
            export BUN_INSTALL=\"\$HOME/.bun\" && \
            export PATH=\"\$BUN_INSTALL/bin:\$PATH\" && \
            NODE_ENV=development npm install --legacy-peer-deps --silent 2>&1 && \
            npm run build 2>&1 && \
            bun run migrate 2>&1 && \
            sed -i 's|ExecStart=.*|ExecStart=/usr/bin/npm run start|' /etc/systemd/system/frost.service && \
            systemctl daemon-reload && \
            systemctl start frost"

          echo "Waiting for Frost on port 3000..."
          for i in {1..24}; do
            if curl -s "http://${{ steps.server.outputs.ip }}:3000/api/health" | grep -q "ok"; then
              echo "Frost is ready!"
              exit 0
            fi
            echo "Attempt $i: Frost not ready..."
            sleep 5
          done
          echo "Frost failed to start"
          ssh root@${{ steps.server.outputs.ip }} "journalctl -u frost --no-pager -n 50" || true
          exit 1

      - name: Test UI-triggered update flow
        if: steps.release.outputs.skip != 'true'
        run: |
          chmod +x ./scripts/e2e-update-ui.sh
          ./scripts/e2e-update-ui.sh \
            "${{ steps.server.outputs.ip }}" \
            "${{ steps.install.outputs.api_key }}" \
            "${{ github.head_ref || github.ref_name }}" \
            "${{ github.repository }}"

      - name: Create broken branch for rollback test
        if: steps.release.outputs.skip != 'true'
        id: broken
        run: |
          BROKEN_BRANCH="frost-e2e-broken-${{ github.run_id }}-${{ matrix.arch }}"
          echo "Creating broken branch: $BROKEN_BRANCH"

          git config user.email "ci@frost.dev"
          git config user.name "Frost CI"
          git checkout -b "$BROKEN_BRANCH"

          # Make the build fail
          echo "console.log('Intentional build failure for e2e test'); process.exit(1);" > fail-build.js
          node -e "
            const pkg = require('./package.json');
            pkg.scripts.build = 'node fail-build.js';
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "

          # Modify update.sh to fetch from this branch instead of main
          sed -i "s|git fetch origin main|git fetch origin $BROKEN_BRANCH:refs/remotes/origin/main|g" update.sh

          git add -A
          git commit -m "Intentionally broken build for e2e rollback test"
          git push origin "$BROKEN_BRANCH"

          echo "branch=$BROKEN_BRANCH" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Reset to release version for rollback test
        if: steps.release.outputs.skip != 'true'
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          echo "Resetting to release $TAG for rollback test..."

          ssh -o ServerAliveInterval=30 root@${{ steps.server.outputs.ip }} "cd /opt/frost && \
            systemctl stop frost && \
            rm -rf repos && \
            git fetch origin && \
            git checkout $TAG && \
            git reset --hard $TAG && \
            git clean -fdx -e data -e .env && \
            export BUN_INSTALL=\"\$HOME/.bun\" && \
            export PATH=\"\$BUN_INSTALL/bin:\$PATH\" && \
            NODE_ENV=development npm install --legacy-peer-deps --silent 2>&1 && \
            npm run build 2>&1 && \
            bun run migrate 2>&1 && \
            sed -i 's|ExecStart=.*|ExecStart=/usr/bin/npm run start|' /etc/systemd/system/frost.service && \
            systemctl daemon-reload && \
            systemctl start frost"

          echo "Waiting for Frost on port 3000..."
          for i in {1..24}; do
            if curl -s "http://${{ steps.server.outputs.ip }}:3000/api/health" | grep -q "ok"; then
              echo "Frost is ready!"
              exit 0
            fi
            echo "Attempt $i: Frost not ready..."
            sleep 5
          done
          echo "Frost failed to start"
          ssh root@${{ steps.server.outputs.ip }} "journalctl -u frost --no-pager -n 50" || true
          exit 1

      - name: Test rollback on build failure
        if: steps.release.outputs.skip != 'true'
        run: |
          chmod +x ./scripts/e2e-update-rollback.sh
          ./scripts/e2e-update-rollback.sh \
            "${{ steps.server.outputs.ip }}" \
            "${{ steps.install.outputs.api_key }}" \
            "${{ steps.broken.outputs.branch }}" \
            "${{ github.repository }}"

      - name: Cleanup broken branch
        if: always() && steps.broken.outputs.branch
        run: |
          echo "Deleting broken branch: ${{ steps.broken.outputs.branch }}"
          git push origin --delete "${{ steps.broken.outputs.branch }}" || true

      - name: Collect logs on failure
        if: failure() && steps.release.outputs.skip != 'true'
        run: |
          echo "=== Frost logs (last 500 lines) ==="
          ssh root@${{ steps.server.outputs.ip }} "journalctl -u frost --no-pager -n 500" || true
          echo ""
          echo "=== Caddy logs ==="
          ssh root@${{ steps.server.outputs.ip }} "journalctl -u caddy --no-pager -n 50" || true
          echo ""
          echo "=== Docker ==="
          ssh root@${{ steps.server.outputs.ip }} "docker ps -a" || true

      - name: Delete server
        if: always() && steps.server.outputs.server_id
        run: |
          echo "Deleting server ${{ steps.server.outputs.server_id }}..."
          curl -s -X DELETE \
            -H "Authorization: Bearer ${{ secrets.HETZNER_API_TOKEN }}" \
            "https://api.hetzner.cloud/v1/servers/${{ steps.server.outputs.server_id }}"
          echo "Server deleted"
